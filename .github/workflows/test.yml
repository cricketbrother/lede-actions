name: test

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      WORKSPACE: /mnt/workspace/lede

    steps:
    
      - name: 创建工作目录
        run: sudo mkdir -p $WORKSPACE && sudo chown -R $USER:$GROUP $WORKSPACE && pwd

      - name: 检出代码
        uses: actions/checkout@main

      - name: 复制lede.sh到工作目录
        run: |
          pwd
          sudo cp lede.sh $WORKSPACE
          sudo chmod +x $WORKSPACE/lede.sh

      - name: 编译LEDE固件
        run: ./lede.sh
        working-directory: ${{ env.WORKSPACE }}

      - name: 创建或清理固件目录
        run: |
          sudo mkdir -p ./firmware/$(cat ${{ env.WORKSPACE }}/lede.version)
          sudo rm -rf ./firmware/$(cat ${{ env.WORKSPACE }}/lede.version)/*

      - name: 上传固件、日志
        run: |
          cp ${{ env.WORKSPACE }}/lede.* ./
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          git commit -m "Add new firmware"
          git push
