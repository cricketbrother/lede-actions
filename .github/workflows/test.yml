name: test

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    defaults:
      run:
        shell: bash
        working-directory: /mnt

    env:
      WORKSPACE: /mnt/workspace

    steps:
      - name: 创建工作目录
        run: sudo mkdir -p $WORKSPACE/lede && sudo chown -R $USER:$GROUP $WORKSPACE 

      # - name: 安装依赖
      #   run: |
      #     sudo apt update -y
      #     sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
      #     bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
      #     genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
      #     libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
      #     libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
      #     python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
      #     swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev\

      - name: 克隆代码
        uses: actions/checkout@main
        with:
          repository: coolsnowwolf/lede
          ref: master
          path: ./workspace/lede

      - name: 更新Feeds
        run: pwd && ./scripts/feeds update -a && ./scripts/feeds install -a
        working-directory: ${{ env.WORKSPACE }}/lede

      - name: 编译固件
        run: make defconfig && make download -j$(nproc) && make -j2 V=s
        working-directory: ${{ env.WORKSPACE }}/lede
